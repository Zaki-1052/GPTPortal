<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPTPortal - Multi-LLM Chat Interface</title>
  <meta name="author" content="Zakir Alibhai">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="chat.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
</head>
<body>
<div>
  <!-- Sidebar for Chat History -->
  <div id="toggleArrow">&#x25B6;</div>
  <div id="sidebar">
    <div id="chatList"></div>
    <div id="summariesButtonContainer">
      <button id="summariesButton">Summaries Only</button>
    </div>
  </div>

  <!-- Prompt Templates Sidebar -->
  <div id="promptBar">
    <div id="promptList"></div>
    <button id="copyPromptButton"></button>
  </div>
  <div id="toggleRightArrow">&#x25C0;</div>
  
  <!-- Custom Tooltip -->
  <div id="custom-tooltip"></div>
  
  <!-- Model Selector with Enhanced Dynamic Loading -->
  <div id="model-selector-container">
    <div class="custom-select" id="selected-model">Select a Model</div>
    <div id="model-search-container">
      <input type="text" id="model-search" placeholder="Search models...">
      <div class="toggle-container">
        <label class="toggle-switch">
          <input type="checkbox" id="show-open-router">
          <span class="toggle-slider"></span>
        </label>
        <span class="toggle-label">Show OpenRouter</span>
      </div>
      <button id="refresh-models" style="margin-left: 10px;">ðŸ”„</button>
    </div>
    <div id="model-options" class="select-options">
      <!-- Models will be populated dynamically -->
      <div id="loading-models" style="text-align: center; padding: 20px;">
        Loading models...
      </div>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div id="chat-container">
    <div id="chat-box">
      <div class="message response">
        Welcome to GPTPortal! Select a model above to start chatting.
        <button onclick="copyToClipboard(this.previousSibling.textContent)">Copy</button>
      </div>
    </div>
    
    <!-- Input Area -->
    <textarea id="message-input" placeholder="Type your message here... (Ctrl+Enter to send)"></textarea>
    
    <!-- Control Buttons -->
    <button type="button" id="clipboard-button">ðŸ“‹</button>
    <input type="file" id="file-input" accept="*/*"/>
    <button type="button" id="export-button">ðŸ“¤</button>
    <button type="button" id="voice-button">ðŸŽ¤</button>
    <div id="voice-indicator">Voice Mode ON</div>
    <button id="send-button">Send</button>
    
    <!-- Mode Selector -->
    <div class="custom-select" id="mode-selector">Assistants Mode</div>
    <div id="upload-status"></div>
    
    <!-- Temperature and Token Sliders -->
    <div id="temperature-slider-container">
      <label for="temperature-slider">Temperature:</label>
      <input type="range" id="temperature-slider" min="0" max="2" step="0.1" value="1">
      <span id="temperature-value">1.0</span>
    </div>
    
    <div id="tokens-slider-container">
      <label for="tokens-slider">Max Tokens:</label>
      <input type="range" id="tokens-slider" min="1000" max="100000" step="500" value="8000">
      <span id="tokens-value">8000</span>
      <span id="tokens-limit">(Model limit: <span id="model-token-limit">8000</span>)</span>
    </div>
  </div>

  <!-- Setup Controls -->
  <button id="edit-instructions-btn" class="custom-select">Edit Instructions</button>
  <div id="edit-instructions-container" style="display:none;">
    <textarea id="instructions-content" rows="10" cols="80"></textarea>
    <button onclick="saveChanges()">Save Changes</button>
  </div>
  
  <button id="edit-env-btn" class="custom-select">Edit Env Variables</button>
  <div id="edit-env-container" style="display:none;">
    <textarea id="env-content" rows="10" cols="80"></textarea>
    <button onclick="saveEnvChanges()">Save Changes</button>
  </div>
</div>

<!-- Load Enhanced Modular System -->
<script src="js/modules/dynamicModelManager.js"></script>
<script src="js/modules/modelConfig.js"></script>
<script src="js/modules/chatManager.js"></script>
<script src="js/modules/uiManager.js"></script>
<script src="js/app.js"></script>

<!-- Enhanced Initialization Script -->
<script>
// Enhanced initialization that ensures everything works together
document.addEventListener('DOMContentLoaded', async function() {
  console.log('Initializing GPTPortal Enhanced System...');
  
  try {
    // Initialize core system
    if (window.gptPortalApp) {
      console.log('Modular system loaded successfully');
      
      // Wait for dynamic models to load
      if (window.gptPortalApp.modelConfig && window.gptPortalApp.modelConfig.dynamicModelManager) {
        await window.gptPortalApp.modelConfig.dynamicModelManager.loadModels();
        console.log('Dynamic models loaded');
      }
      
      // Initialize legacy functions for backward compatibility
      initializeLegacyFunctions();
      
      // Setup additional event handlers
      setupEnhancedFeatures();
      
    } else {
      console.warn('Modular system not available, initializing basic functionality');
      initializeBasicFunctionality();
    }
    
  } catch (error) {
    console.error('Error during initialization:', error);
    // Fallback to basic functionality
    initializeBasicFunctionality();
  }
});

function initializeLegacyFunctions() {
  // Ensure all original script.js functions are available
  
  // Global variables for backward compatibility
  window.selectedImage = null;
  window.voiceMode = false;
  window.mediaRecorder = null;
  window.audioChunks = [];
  window.isVoiceTranscription = false;
  window.temperature = 1;
  window.tokens = 8000;
  
  // Copy functions from original script.js
  window.copyToClipboard = function(text) {
    navigator.clipboard.writeText(text).then(() => {
      console.log('Text copied to clipboard!');
    }).catch(err => {
      console.error('Error copying text: ', err);
    });
  };
  
  // File upload handling
  window.uploadFile = async function(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch('/upload-file', {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();
      return data.fileId;
    } catch (error) {
      console.error('Error uploading file:', error);
    }
  };
  
  // Voice functionality
  window.voice = function() {
    console.log("Voice button clicked. Current mode:", window.voiceMode);
    
    if (isSafariBrowser()) {
      displayErrorMessage('Safari browser detected. Please use a Chromium browser for voice functionality.');
      return;
    }
  
    if (window.voiceMode) {
      stopRecordingAndTranscribe();
    } else {
      startRecording();
    }
    toggleVoiceMode();
  };
  
  window.isSafariBrowser = function() {
    return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  };
  
  window.displayErrorMessage = function(message) {
    const errorMessage = document.createElement('div');
    errorMessage.className = 'message error';
    errorMessage.textContent = message;
    const chatBox = document.getElementById('chat-box');
    chatBox.appendChild(errorMessage);
    chatBox.scrollTop = chatBox.scrollHeight;
  };
  
  window.startRecording = function() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        window.mediaRecorder = new MediaRecorder(stream);
        window.mediaRecorder.ondataavailable = e => {
          window.audioChunks.push(e.data);
        };
        window.mediaRecorder.onstop = sendAudioToServer;
        window.mediaRecorder.start();
        console.log("Recording started");
      })
      .catch(error => {
        console.error("Error accessing media devices:", error);
      });
  };
  
  window.stopRecordingAndTranscribe = function() {
    if (window.mediaRecorder && window.mediaRecorder.state === "recording") {
      window.mediaRecorder.stop();
      console.log("Recording stopped");
    }
  };
  
  window.toggleVoiceMode = function() {
    window.voiceMode = !window.voiceMode;
    const voiceIndicator = document.getElementById('voice-indicator');
    if (window.voiceMode) {
      voiceIndicator.textContent = 'Voice Mode ON';
      voiceIndicator.style.display = 'block';
    } else {
      voiceIndicator.style.display = 'none';
    }
  };
  
  window.sendAudioToServer = function() {
    const audioBlob = new Blob(window.audioChunks, { type: 'audio/mpeg' });
    const formData = new FormData();
    formData.append('file', audioBlob, 'recording.mp3');
    window.audioChunks = [];
    
    setTimeout(() => {
      fetch('/transcribe', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        const messageInput = document.getElementById('message-input');
        if (data && data.text) {
          messageInput.value = data.text;
          window.isVoiceTranscription = data.text.startsWith("Voice Transcription: ");
          window.copyToClipboard(data.text);
        }
        window.voiceMode = false;
      })
      .catch(console.error);
    }, 100);
  };
  
  // Text-to-speech function
  window.callTTSAPI = function(text) {
    fetch('/tts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ text: text })
    })
    .then(response => response.blob())
    .then(blob => {
      const audioURL = URL.createObjectURL(blob);
      new Audio(audioURL).play();
    })
    .catch(console.error);
  };
  
  // Setup/config functions
  window.saveChanges = function() {
    const content = document.getElementById('instructions-content').value;
    
    navigator.clipboard.writeText('node server.js').then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Could not copy text: ', err);
    });

    fetch('/update-instructions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data);
      alert('Changes saved successfully');
      document.getElementById('edit-instructions-container').style.display = 'none';
      document.body.innerHTML = '<h2>Complete. Please restart the server and access the web app at <a href="http://localhost:3000">localhost:3000</a>. Simply paste `node server.js` into your Terminal to start again, reloading the page.</h2>';
      
      fetch('/shutdown-server', {
        method: 'POST'
      }).then(restartResponse => {
        if (restartResponse.ok) {
          console.log('Server shutdown initiated');
        } else {
          console.error('Failed to initiate server shutdown');
        }
      }).catch(err => {
        console.error('Error:', err);
      });
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred during setup. Please try again.');
    });
  };
  
  window.saveEnvChanges = function() {
    const content = document.getElementById('env-content').value;
    
    navigator.clipboard.writeText('node server.js').then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Could not copy text: ', err);
    });

    fetch('/update-my-env', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Success:', data);
      alert('Changes saved successfully');
      document.getElementById('edit-env-container').style.display = 'none';
      document.body.innerHTML = '<h2>Setup is complete. Please restart the server and access the web app at <a href="http://localhost:3000">localhost:3000</a>. Simply paste `node server.js` into your Terminal to start again, reloading the page.</h2>';
      
      fetch('/shutdown-server', {
        method: 'POST'
      }).then(restartResponse => {
        if (restartResponse.ok) {
          console.log('Server shutdown initiated');
        } else {
          console.error('Failed to initiate server shutdown');
        }
      }).catch(err => {
        console.error('Error:', err);
      });
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred during setup. Please try again.');
    });
  };
}

function setupEnhancedFeatures() {
  // Setup advanced features that weren't in the basic modules
  
  // Voice button
  const voiceButton = document.getElementById('voice-button');
  if (voiceButton) {
    voiceButton.addEventListener('click', window.voice);
  }
  
  // Export button
  const exportButton = document.getElementById('export-button');
  if (exportButton) {
    exportButton.addEventListener('click', () => {
      if (window.gptPortalApp && window.gptPortalApp.chatManager) {
        window.gptPortalApp.chatManager.exportChat();
      }
    });
  }
  
  // Setup/config buttons
  const editInstructionsBtn = document.getElementById('edit-instructions-btn');
  if (editInstructionsBtn) {
    editInstructionsBtn.addEventListener('click', function() {
      const container = document.getElementById('edit-instructions-container');
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      
      if (isHidden) {
        fetch('/get-instructions', {
          credentials: 'include'
        })
          .then(response => response.text())
          .then(data => {
            document.getElementById('instructions-content').value = data;
            container.scrollIntoView({ behavior: 'smooth' });
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    });
  }
  
  const editEnvBtn = document.getElementById('edit-env-btn');
  if (editEnvBtn) {
    editEnvBtn.addEventListener('click', function() {
      const container = document.getElementById('edit-env-container');
      const isHidden = container.style.display === 'none';
      container.style.display = isHidden ? 'block' : 'none';
      
      if (isHidden) {
        fetch('/get-my-env')
          .then(response => response.text())
          .then(data => {
            document.getElementById('env-content').value = data;
            container.scrollIntoView({ behavior: 'smooth' });
          })
          .catch(error => {
            console.error('Error:', error);
          });
      }
    });
  }
  
  // Enhanced keyboard shortcuts
  document.addEventListener('keydown', (event) => {
    // SHIFT+ESC for focusing the chat input
    if (event.shiftKey && event.key === 'Escape') {
      event.preventDefault();
      const messageInput = document.getElementById('message-input');
      if (messageInput) messageInput.focus();
    }

    // CMD+SHIFT+X for exporting chat history
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'X') {
      console.log("exporting");
      event.preventDefault();
      if (window.gptPortalApp && window.gptPortalApp.chatManager) {
        window.gptPortalApp.chatManager.exportChat();
      }
    }

    // CMD+SHIFT+V for toggling voice mode
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'V') {
      event.preventDefault();
      window.voice();
    }

    // CMD+SHIFT+C for copying the latest chat message
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'C') {
      event.preventDefault();
      const copyButtons = document.querySelectorAll('.message button');
      const latestCopyButton = Array.from(copyButtons).reverse().find(btn => btn.textContent.includes('Copy') && !btn.textContent.includes('Copy Code'));
      if (latestCopyButton) {
        latestCopyButton.click();
      }
    }

    // CMD+SHIFT+; for copying the latest code block
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === ';') {
      event.preventDefault();
      const copyCodeButtons = document.querySelectorAll('.message button');
      const latestCopyCodeButton = Array.from(copyCodeButtons).reverse().find(btn => btn.textContent.includes('Copy Code'));
      if (latestCopyCodeButton) {
        latestCopyCodeButton.click();
      }
    }

    // CMD+SHIFT+F for focusing the file input
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'F') {
      event.preventDefault();
      const fileInput = document.getElementById('file-input');
      if (fileInput) {
        fileInput.click();
      }
    }

    // CMD+SHIFT+A for toggling Assistant Mode
    if ((event.metaKey || event.ctrlKey) && event.shiftKey && event.key === 'A') {
      event.preventDefault();
      const modeSelector = document.getElementById('mode-selector');
      if (modeSelector) {
        modeSelector.click();
      }
    }
  });
  
  // Auto-expand textarea
  const messageInput = document.getElementById('message-input');
  if (messageInput) {
    messageInput.addEventListener('input', function() {
      autoExpand(this);
    });
  }
  
  function autoExpand(field) {
    field.style.height = 'inherit';
    const computed = window.getComputedStyle(field);
    const borderTop = parseInt(computed.getPropertyValue('border-top-width'), 10);
    const borderBottom = parseInt(computed.getPropertyValue('border-bottom-width'), 10);
    const paddingTop = parseInt(computed.getPropertyValue('padding-top'), 10);
    const paddingBottom = parseInt(computed.getPropertyValue('padding-bottom'), 10);
    const heightNeeded = field.scrollHeight + borderTop + borderBottom;
    
    if (field.scrollHeight > field.clientHeight - paddingTop - paddingBottom - borderTop - borderBottom) {
      field.style.height = `${heightNeeded}px`;
    }
  }
  
  window.resetTextAreaHeight = function(field) {
    field.style.height = '40px';
    autoExpand(field);
  };
}

function initializeBasicFunctionality() {
  // Fallback initialization if modular system fails
  console.log('Initializing basic functionality...');
  
  // Basic model selector
  const selectedModel = document.getElementById('selected-model');
  const modelOptions = document.getElementById('model-options');
  
  if (selectedModel && modelOptions) {
    selectedModel.addEventListener('click', () => {
      modelOptions.style.display = modelOptions.style.display === 'block' ? 'none' : 'block';
    });
  }
  
  // Basic send button
  const sendButton = document.getElementById('send-button');
  const messageInput = document.getElementById('message-input');
  
  if (sendButton && messageInput) {
    sendButton.addEventListener('click', () => {
      const message = messageInput.value.trim();
      if (message) {
        console.log('Sending message:', message);
        // Basic message sending would go here
        messageInput.value = '';
      }
    });
  }
}

console.log('GPTPortal Enhanced Frontend initialized');
</script>

</body>
</html>